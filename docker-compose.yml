# Rustscape Docker Compose Configuration
#
# This file uses environment variables from .env file.
# Run ./run.sh init to generate the .env file with secure credentials.

services:
    # ===========================================
    # RUST SERVER STACK
    # ===========================================

    # Rust Game Server
    server:
        build:
            context: .
            dockerfile: ./docker/server/Dockerfile
        container_name: "rustscape_server"
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        restart: unless-stopped
        volumes:
            - "rustscape_server_data:/app/data"
            - "rustscape_server_logs:/app/logs"
            - "rustscape_cache:/app/data/cache"
            - "rustscape_sprites:/app/data/extracted/sprites"
        environment:
            TZ: ${TZ:-America/New_York}
            RUST_LOG: ${RUST_LOG:-info,rustscape_server=debug}
            RUSTSCAPE_DEV_MODE: ${RUSTSCAPE_DEV_MODE:-true}
            # PostgreSQL
            RUSTSCAPE_DATABASE_TYPE: ${RUSTSCAPE_DATABASE_TYPE:-postgres}
            RUSTSCAPE_DATABASE_HOST: ${RUSTSCAPE_DATABASE_HOST:-postgres}
            RUSTSCAPE_DATABASE_PORT: ${RUSTSCAPE_DATABASE_PORT:-5432}
            RUSTSCAPE_DATABASE_USER: ${RUSTSCAPE_DATABASE_USER:-rustscape}
            RUSTSCAPE_DATABASE_PASSWORD: ${POSTGRES_PASSWORD}
            RUSTSCAPE_DATABASE_NAME: ${RUSTSCAPE_DATABASE_NAME:-rustscape}
            # Redis
            RUSTSCAPE_REDIS_HOST: ${RUSTSCAPE_REDIS_HOST:-redis}
            RUSTSCAPE_REDIS_PORT: ${RUSTSCAPE_REDIS_PORT:-6379}
            RUSTSCAPE_REDIS_PASSWORD: ${REDIS_PASSWORD:-}
            # JWT Authentication
            RUSTSCAPE_JWT_SECRET: ${RUSTSCAPE_JWT_SECRET}
            RUSTSCAPE_JWT_ACCESS_EXPIRY: ${RUSTSCAPE_JWT_ACCESS_EXPIRY:-86400}
            RUSTSCAPE_JWT_REFRESH_EXPIRY: ${RUSTSCAPE_JWT_REFRESH_EXPIRY:-604800}
            # Authentication settings
            RUSTSCAPE_AUTH_REGISTRATION_ENABLED: ${RUSTSCAPE_AUTH_REGISTRATION_ENABLED:-true}
            RUSTSCAPE_AUTH_MIN_PASSWORD_LENGTH: ${RUSTSCAPE_AUTH_MIN_PASSWORD_LENGTH:-6}
            RUSTSCAPE_AUTH_MAX_LOGIN_ATTEMPTS: ${RUSTSCAPE_AUTH_MAX_LOGIN_ATTEMPTS:-5}
            RUSTSCAPE_AUTH_LOCKOUT_DURATION: ${RUSTSCAPE_AUTH_LOCKOUT_DURATION:-900}
            RUSTSCAPE_AUTH_BCRYPT_COST: ${RUSTSCAPE_AUTH_BCRYPT_COST:-12}
            # Server settings
            RUSTSCAPE_WORLD_ID: ${RUSTSCAPE_WORLD_ID:-1}
            RUSTSCAPE_WORLD_NAME: ${RUSTSCAPE_WORLD_NAME:-Rustscape}
            RUSTSCAPE_MAX_PLAYERS: ${RUSTSCAPE_MAX_PLAYERS:-2000}
        ports:
            - "43597:43594" # Base game port
            - "43598:43595" # World 1 game port
            - "43599:43596" # WebSocket port
            - "5556:5555" # Management API
        networks:
            - rustscape_network
        healthcheck:
            test: ["CMD", "nc", "-z", "localhost", "43596"]
            interval: 30s
            timeout: 10s
            start_period: 60s
            retries: 5
        deploy:
            resources:
                limits:
                    cpus: "4"
                    memory: 2G

    # Web server for browser client (nginx)
    nginx:
        build:
            context: .
            dockerfile: ./docker/nginx/Dockerfile
        container_name: "rustscape_nginx"
        restart: unless-stopped
        depends_on:
            server:
                condition: service_healthy
        ports:
            - "${NGINX_HTTP_PORT:-8088}:80"
            - "${NGINX_HTTPS_PORT:-8443}:443"
        volumes:
            - "rustscape_cache:/usr/share/nginx/html/assets/cache:ro"
            - "rustscape_sprites:/usr/share/nginx/html/sprites:ro"
            - "./config/ssl:/etc/nginx/ssl:ro"
        environment:
            GAME_SERVER_HOST: server
            GAME_SERVER_WS_PORT: 43596
        networks:
            - rustscape_network
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost/health"]
            interval: 30s
            timeout: 10s
            start_period: 10s
            retries: 3
        deploy:
            resources:
                limits:
                    cpus: "1"
                    memory: 512M

    # ===========================================
    # CORE INFRASTRUCTURE
    # ===========================================

    # PostgreSQL Database (primary data store)
    postgres:
        image: postgres:16-alpine
        container_name: "rustscape_postgres"
        restart: unless-stopped
        ports:
            - "${POSTGRES_EXTERNAL_PORT:-5433}:5432"
        volumes:
            - "rustscape_postgres_data:/var/lib/postgresql/data"
            - "./config/postgres/init:/docker-entrypoint-initdb.d:ro"
        environment:
            TZ: ${TZ:-America/New_York}
            POSTGRES_USER: ${POSTGRES_USER:-rustscape}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB:-rustscape}
        networks:
            - rustscape_network
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "pg_isready -U $${POSTGRES_USER:-rustscape} -d $${POSTGRES_DB:-rustscape}",
                ]
            interval: 10s
            timeout: 5s
            retries: 5
        deploy:
            resources:
                limits:
                    cpus: "2"
                    memory: 1G

    # Redis Cache (sessions, caching, pub/sub)
    redis:
        image: redis:7-alpine
        container_name: "rustscape_redis"
        restart: unless-stopped
        ports:
            - "${REDIS_EXTERNAL_PORT:-6380}:6379"
        volumes:
            - "rustscape_redis_data:/data"
            - "./config/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro"
        command: redis-server /usr/local/etc/redis/redis.conf
        environment:
            TZ: ${TZ:-America/New_York}
        networks:
            - rustscape_network
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5
        deploy:
            resources:
                limits:
                    cpus: "1"
                    memory: 512M

    # ===========================================
    # DEVELOPMENT TOOLS
    # ===========================================

    # pgAdmin for PostgreSQL management
    pgadmin:
        image: dpage/pgadmin4:latest
        container_name: "rustscape_pgadmin"
        restart: unless-stopped
        depends_on:
            postgres:
                condition: service_healthy
        ports:
            - "${PGADMIN_PORT:-5050}:80"
        environment:
            PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@rustscape.local}
            PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
            PGADMIN_CONFIG_SERVER_MODE: "False"
        volumes:
            - "rustscape_pgadmin_data:/var/lib/pgadmin"
        networks:
            - rustscape_network
        profiles:
            - dev

    # Redis Commander for Redis management
    redis-commander:
        image: rediscommander/redis-commander:latest
        container_name: "rustscape_redis_commander"
        restart: unless-stopped
        depends_on:
            redis:
                condition: service_healthy
        ports:
            - "${REDIS_COMMANDER_PORT:-8081}:8081"
        environment:
            REDIS_HOSTS: local:redis:6379
        networks:
            - rustscape_network
        profiles:
            - dev

# Named volumes for persistent data
volumes:
    # Infrastructure
    rustscape_postgres_data:
    rustscape_redis_data:
    rustscape_pgadmin_data:
    # Server
    rustscape_server_data:
    rustscape_server_logs:
    # Shared game assets (server writes, nginx reads)
    rustscape_cache:
    rustscape_sprites:

# Docker network
networks:
    rustscape_network:
        driver: bridge
